openapi: 3.1.1

info:
  title: E-Commerce API
  version: 1.0.0
  description: |
    A RESTful API for managing an e-commerce platform with product catalog, 
    shopping cart, order management, and payment processing via Stripe.

    ## Authentication
    Most endpoints require JWT authentication via Bearer token in the Authorization header.
    Refresh tokens are managed via HTTP-only cookies.

    ## User Roles
    - **Client**: Regular users who can browse, purchase, and manage their own data
    - **Manager**: Administrative users with product and order management capabilities

servers:
  - url: /api/v1
    description: API v1 base path

tags:
  - name: Authentication
    description: User registration, login, password management
  - name: User Profile
    description: User profile and address management
  - name: Categories
    description: Product category management
  - name: Products
    description: Product catalog operations
  - name: Variants & Images
    description: Product variant and image management
  - name: Favorites
    description: Product wishlist/favorites
  - name: Cart
    description: Shopping cart management
  - name: Orders
    description: Order creation and management
  - name: Payments
    description: Payment processing via Stripe
  - name: Webhooks
    description: External webhook endpoints

paths:
  /auth/sign-up:
    post:
      tags:
        - Authentication
      summary: Register a new user
      description: |
        Creates a new user account and returns an access token for immediate authentication.
        Validates email format and password strength.
      operationId: registerUser
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - email
                - password
                - full_name
              properties:
                email:
                  type: string
                  format: email
                  example: alex@example.com
                password:
                  type: string
                  format: password
                  minLength: 8
                  example: securePassword123!
                full_name:
                  type: string
                  example: Alex Dev
      responses:
        '201':
          description: User successfully registered
          content:
            application/json:
              schema:
                type: object
                properties:
                  access_token:
                    type: string
                    description: JWT access token for API authentication
                    example: eyJhGci...
                  user:
                    $ref: '#/components/schemas/User'
        '409':
          description: Email already registered
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                status: 409
                error:
                  code: "EMAIL_ALREADY_EXISTS"
                  message: "Email already in use"
                  path: "/api/v1/auth/sign-up"

  /auth/sign-in:
    post:
      tags:
        - Authentication
      summary: Authenticate user
      description: |
        Authenticates a user with email and password. Returns access token and sets 
        refresh token as HTTP-only cookie.
      operationId: loginUser
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - email
                - password
              properties:
                email:
                  type: string
                  format: email
                password:
                  type: string
                  format: password
      responses:
        '200':
          description: Successfully authenticated
          headers:
            Set-Cookie:
              description: HTTP-only cookie containing refresh token
              schema:
                type: string
                example: refresh_token=rHt8...; HttpOnly; Secure; SameSite=Strict
          content:
            application/json:
              schema:
                type: object
                properties:
                  access_token:
                    type: string
                    example: eyJhGci...
                  refresh_token:
                    type: string
                    description: Also set as HTTP-only cookie
                    example: rHt8...
                  user:
                    $ref: '#/components/schemas/User'
        '401':
          description: Invalid credentials
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                status: 401
                error:
                  code: "INVALID_CREDENTIALS"
                  message: "Invalid email or password"
                  path: "/api/v1/auth/sign-in"

  /auth/sign-out:
    post:
      tags:
        - Authentication
      summary: Sign out user
      description: |
        Invalidates the refresh token and clears authentication cookies.
        Requires valid refresh token in request body or cookie.
      operationId: signOutUser
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - refresh_token
              properties:
                refresh_token:
                  type: string
                  description: Refresh token to invalidate
      responses:
        '200':
          description: Successfully signed out
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Logged out successfully

  /auth/forgot-password:
    post:
      tags:
        - Authentication
      summary: Request password reset
      description: |
        Sends a password reset link to the user's email if the account exists.
        Always returns success to prevent email enumeration attacks.
      operationId: forgotPassword
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - email
              properties:
                email:
                  type: string
                  format: email
      responses:
        '200':
          description: Request processed (email sent if account exists)
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: If the email exists, a reset link has been sent.

  /auth/reset-password:
    post:
      tags:
        - Authentication
      summary: Reset password with token
      description: |
        Resets user password using the token from the password reset email.
        Sends confirmation email upon successful reset.
      operationId: resetPassword
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - token
                - new_password
              properties:
                token:
                  type: string
                  description: Token from password reset email
                new_password:
                  type: string
                  format: password
                  minLength: 8
      responses:
        '200':
          description: Password successfully reset
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Password successfully updated
        '400':
          description: Invalid or expired token
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                status: 400
                error:
                  code: "INVALID_RESET_TOKEN"
                  message: "Reset token is invalid or has expired"
                  path: "/api/v1/auth/reset-password"

  /auth/refresh:
    post:
      tags:
        - Authentication
      summary: Refresh access token
      description: |
        Generates a new access token using a valid refresh token.
        Returns new access token and optionally a new refresh token.
      operationId: refreshToken
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - refresh_token
              properties:
                refresh_token:
                  type: string
                  description: Valid refresh token
      responses:
        '200':
          description: Token refreshed successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  access_token:
                    type: string
                    example: eyJhGci...
                  refresh_token:
                    type: string
                    example: rHt8...
        '401':
          description: Invalid or expired refresh token
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                status: 401
                error:
                  code: "INVALID_REFRESH_TOKEN"
                  message: "Invalid refresh token"
                  path: "/api/v1/auth/refresh"

  /me:
    get:
      tags:
        - User Profile
      summary: Get current user profile
      description: Returns the authenticated user's profile information
      operationId: getUserProfile
      security:
        - bearerAuth: []
      responses:
        '200':
          description: User profile retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserProfile'
    
    patch:
      tags:
        - User Profile
      summary: Update user profile
      description: |
        Updates user profile information. All fields are optional.
        Email changes may require verification depending on implementation.
      operationId: updateUserProfile
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                full_name:
                  type: string
                  example: Alexander Developer
                email:
                  type: string
                  format: email
                  example: newemail@example.com
      responses:
        '200':
          description: Profile successfully updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserProfile'
        '409':
          description: Email already in use by another account
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                status: 409
                error:
                  code: "EMAIL_ALREADY_EXISTS"
                  message: "Email already in use"
                  path: "/api/v1/me"

  /me/change-password:
    patch:
      tags:
        - User Profile
      summary: Change user password
      description: |
        Changes the authenticated user's password. Requires current password for verification.
        Sends email notification upon successful change.
      operationId: changePassword
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - current_password
                - new_password
              properties:
                current_password:
                  type: string
                  format: password
                new_password:
                  type: string
                  format: password
                  minLength: 8
      responses:
        '200':
          description: Password successfully changed
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Password successfully changed
        '401':
          description: Current password is incorrect
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                status: 401
                error:
                  code: "INVALID_PASSWORD"
                  message: "Current password is incorrect"
                  path: "/api/v1/me/change-password"

  /me/addresses:
    get:
      tags:
        - User Profile
      summary: List user addresses
      description: Returns all saved addresses for the authenticated user
      operationId: listUserAddresses
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Addresses retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  addresses:
                    type: array
                    items:
                      $ref: '#/components/schemas/Address'
    
    post:
      tags:
        - User Profile
      summary: Add new address
      description: Adds a new shipping/billing address for the authenticated user
      operationId: addUserAddress
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AddressInput'
      responses:
        '201':
          description: Address created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Address'

  /me/addresses/{id}:
    delete:
      tags:
        - User Profile
      summary: Remove address
      description: Deletes a saved address for the authenticated user
      operationId: removeUserAddress
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          description: Address ID
          schema:
            type: string
            format: uuid
      responses:
        '204':
          description: Address deleted successfully

  /categories:
    get:
      tags:
        - Categories
      summary: List all categories
      description: |
        Returns all product categories with computed product counts.
        Publicly accessible without authentication.
      operationId: listCategories
      responses:
        '200':
          description: Categories retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  categories:
                    type: array
                    items:
                      $ref: '#/components/schemas/CategoryWithCount'
    
    post:
      tags:
        - Categories
      summary: Create category
      description: Creates a new product category. Manager access required.
      operationId: createCategory
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - name
              properties:
                name:
                  type: string
                  example: Summer Collection 2026
      responses:
        '201':
          description: Category created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Category'
        '409':
          description: Category name already exists
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                status: 409
                error:
                  code: "CATEGORY_ALREADY_EXISTS"
                  message: "Category name already exists"
                  path: "/api/v1/categories"

  /categories/{id}:
    get:
      tags:
        - Categories
      summary: Get category details
      description: Returns detailed information about a specific category
      operationId: getCategoryDetails
      parameters:
        - name: id
          in: path
          required: true
          description: Category ID
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Category details retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Category'
    
    patch:
      tags:
        - Categories
      summary: Update category
      description: Updates category information. Manager access required.
      operationId: updateCategory
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          description: Category ID
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
                  example: Winter Collection
      responses:
        '200':
          description: Category updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Category'
        '409':
          description: Category name already exists
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                status: 409
                error:
                  code: "CATEGORY_ALREADY_EXISTS"
                  message: "Category name already exists"
                  path: "/api/v1/categories/{id}"
    
    delete:
      tags:
        - Categories
      summary: Delete category
      description: |
        Deletes a category. Manager access required.
        May fail if category contains products depending on implementation.
      operationId: deleteCategory
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          description: Category ID
          schema:
            type: string
            format: uuid
      responses:
        '204':
          description: Category deleted successfully
        '409':
          description: Category cannot be deleted (contains products)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                status: 409
                error:
                  code: "CATEGORY_HAS_PRODUCTS"
                  message: "Cannot delete category with existing products"
                  path: "/api/v1/categories/{id}"

  /products:
    get:
      tags:
        - Products
      summary: List products
      description: |
        Returns paginated list of products with filtering and search capabilities.
        Publicly accessible. Returns only active products unless accessed by manager.
      operationId: listProducts
      parameters:
        - name: page
          in: query
          description: Page number for pagination
          schema:
            type: integer
            minimum: 1
            default: 1
        - name: limit
          in: query
          description: Number of items per page
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
        - name: search
          in: query
          description: Search term for product title or description
          schema:
            type: string
            example: shirt
        - name: category_id
          in: query
          description: Filter products by category
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Products retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/ProductListItem'
                  meta:
                    $ref: '#/components/schemas/PaginationMeta'
    
    post:
      tags:
        - Products
      summary: Create product
      description: |
        Creates a new product with options and variants. Manager access required.
        Options define selectable attributes (e.g., Color, Size).
        Variants represent specific combinations with individual pricing and stock.
      operationId: createProduct
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ProductInput'
      responses:
        '201':
          description: Product created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProductCreated'

  /products/{id}:
    get:
      tags:
        - Products
      summary: Get product details
      description: |
        Returns complete product information including all variants, options, and images.
        Publicly accessible. Variants include combination mappings for UI selection.
      operationId: getProductDetails
      parameters:
        - name: id
          in: path
          required: true
          description: Product ID
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Product details retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProductDetails'
    
    patch:
      tags:
        - Products
      summary: Update product
      description: |
        Updates product information including activation status.
        Manager access required. Set is_active to false to disable product.
      operationId: updateProduct
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          description: Product ID
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                title:
                  type: string
                description:
                  type: string
                is_active:
                  type: boolean
                  description: Set to false to disable/hide product
      responses:
        '200':
          description: Product updated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  id:
                    type: string
                    format: uuid
                  title:
                    type: string
                  description:
                    type: string
                  is_active:
                    type: boolean
                  updated_at:
                    type: string
                    format: date-time
    
    delete:
      tags:
        - Products
      summary: Delete product
      description: |
        Deletes a product and all associated variants and images.
        Manager access required.
      operationId: deleteProduct
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          description: Product ID
          schema:
            type: string
            format: uuid
      responses:
        '204':
          description: Product deleted successfully

  /products/{id}/variants:
    post:
      tags:
        - Variants & Images
      summary: Create product variant
      description: |
        Adds a new variant to an existing product. Manager access required.
        Variant represents a specific combination of options with unique SKU, price, and stock.
      operationId: createProductVariant
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          description: Product ID
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/VariantInput'
      responses:
        '201':
          description: Variant created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Variant'
        '409':
          description: Variant with same option combination already exists
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                status: 409
                error:
                  code: "VARIANT_ALREADY_EXISTS"
                  message: "Variant with same option combination already exists"
                  path: "/api/v1/products/{id}/variants"

  /product-variants/{id}:
    patch:
      tags:
        - Variants & Images
      summary: Update product variant
      description: |
        Updates variant price and stock quantity. Manager access required.
        SKU and option combinations cannot be changed after creation.
      operationId: updateProductVariant
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          description: Variant ID
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                price:
                  type: integer
                  description: Price in cents
                  example: 2299
                stock_quantity:
                  type: integer
                  minimum: 0
                  example: 25
      responses:
        '200':
          description: Variant updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Variant'

  /variants/{id}:
    delete:
      tags:
        - Variants & Images
      summary: Delete variant
      description: |
        Deletes a product variant. Manager access required.
        Cannot delete if variant is the last one for the product.
      operationId: deleteProductVariant
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          description: Variant ID
          schema:
            type: string
            format: uuid
      responses:
        '204':
          description: Variant deleted successfully
        '409':
          description: Cannot delete last variant of product
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                status: 409
                error:
                  code: "CANNOT_DELETE_LAST_VARIANT"
                  message: "Cannot delete the last variant of a product"
                  path: "/api/v1/variants/{id}"

  /products/{id}/images:
    post:
      tags:
        - Variants & Images
      summary: Upload product image
      description: |
        Uploads an image for a product or specific variant. Manager access required.
        Images can be associated with the entire product or a specific variant.
      operationId: uploadProductImage
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          description: Product ID
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required:
                - file
              properties:
                file:
                  type: string
                  format: binary
                  description: Image file (JPEG, PNG, WebP)
                product_variant_id:
                  type: string
                  format: uuid
                  description: Optional variant ID if image is specific to a variant
      responses:
        '201':
          description: Image uploaded successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProductImage'

  /product-images/{id}:
    delete:
      tags:
        - Variants & Images
      summary: Delete product image
      description: Deletes a product or variant image. Manager access required.
      operationId: deleteProductImage
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          description: Image ID
          schema:
            type: string
            format: uuid
      responses:
        '204':
          description: Image deleted successfully

  /products/{id}/favorites:
    post:
      tags:
        - Favorites
      summary: Add product to favorites
      description: |
        Adds a product to the authenticated user's favorites/wishlist.
        When a favorited product's stock reaches 3 and the user hasn't purchased it,
        an email notification is sent.
      operationId: addProductToFavorites
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          description: Product ID
          schema:
            type: string
            format: uuid
      responses:
        '201':
          description: Product added to favorites
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Added to favorites
        '409':
          description: Product already in favorites
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                status: 409
                error:
                  code: "ALREADY_IN_FAVORITES"
                  message: "Product already in favorites"
                  path: "/api/v1/products/{id}/favorites"
    
    delete:
      tags:
        - Favorites
      summary: Remove product from favorites
      description: Removes a product from the authenticated user's favorites
      operationId: removeProductFromFavorites
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          description: Product ID
          schema:
            type: string
            format: uuid
      responses:
        '204':
          description: Product removed from favorites

  /carts:
    get:
      tags:
        - Cart
      summary: Get shopping cart
      description: |
        Returns the current user's shopping cart with all items and calculated totals.
        Cart is user-specific and persists across sessions.
      operationId: getCart
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Cart retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Cart'
    
    delete:
      tags:
        - Cart
      summary: Clear shopping cart
      description: Removes all items from the cart
      operationId: clearCart
      security:
        - bearerAuth: []
      responses:
        '204':
          description: Cart cleared successfully

  /carts/items:
    post:
      tags:
        - Cart
      summary: Add item to cart
      description: |
        Adds a product variant to the cart or updates quantity if already present.
        Returns the updated cart with recalculated totals.
      operationId: addCartItem
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - product_variant_id
                - quantity
              properties:
                product_variant_id:
                  type: string
                  format: uuid
                quantity:
                  type: integer
                  minimum: 1
                  example: 2
      responses:
        '200':
          description: Item added to cart
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Cart'
        '400':
          description: Invalid quantity or insufficient stock
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                status: 400
                error:
                  code: "INSUFFICIENT_STOCK"
                  message: "Insufficient stock available"
                  path: "/api/v1/carts/items"

  /carts/items/{id}:
    patch:
      tags:
        - Cart
      summary: Update cart item quantity
      description: |
        Updates the quantity of a specific cart item.
        Returns the updated cart with recalculated totals.
      operationId: updateCartItemQuantity
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          description: Cart item ID
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - quantity
              properties:
                quantity:
                  type: integer
                  minimum: 1
                  example: 12
      responses:
        '200':
          description: Cart item updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Cart'
        '400':
          description: Invalid quantity or insufficient stock
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                status: 400
                error:
                  code: "INSUFFICIENT_STOCK"
                  message: "Insufficient stock available"
                  path: "/api/v1/carts/items/{id}"
    
    delete:
      tags:
        - Cart
      summary: Remove item from cart
      description: |
        Removes a specific item from the cart.
        Returns the updated cart with recalculated totals.
      operationId: removeCartItem
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          description: Cart item ID
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Item removed from cart
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Cart'

  /orders:
    get:
      tags:
        - Orders
      summary: List orders
      description: |
        Returns orders for the authenticated user.
        - Clients see only their own orders
        - Managers see all orders across all users
      operationId: listOrders
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Orders retrieved successfully
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/OrderSummary'
    
    post:
      tags:
        - Orders
      summary: Create order (checkout)
      description: |
        Creates an order from the current cart contents. Requires shipping address.
        Cart is cleared upon successful order creation. Product details and prices
        are captured as snapshots for historical accuracy.
      operationId: createOrder
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - shipping_address
              properties:
                shipping_address:
                  $ref: '#/components/schemas/AddressInput'
      responses:
        '201':
          description: Order created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OrderDetails'
        '400':
          description: Cart is empty or invalid address
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                status: 400
                error:
                  code: "EMPTY_CART"
                  message: "Cart is empty"
                  path: "/api/v1/orders"

  /orders/{id}:
    get:
      tags:
        - Orders
      summary: Get order details
      description: |
        Returns detailed information about a specific order.
        - Clients can only access their own orders
        - Managers can access any order
      operationId: getOrderDetails
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          description: Order ID
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Order details retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OrderDetails'
        '403':
          description: Not authorized to access this order
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                status: 403
                error:
                  code: "FORBIDDEN"
                  message: "Not authorized to access this order"
                  path: "/api/v1/orders/{id}"

  /orders/{id}/status:
    patch:
      tags:
        - Orders
      summary: Update order status
      description: |
        Updates the status of an order. Manager access required.
        Valid statuses: pending, processing, shipped, delivered, cancelled
      operationId: updateOrderStatus
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          description: Order ID
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - status
              properties:
                status:
                  type: string
                  enum:
                    - pending
                    - processing
                    - shipped
                    - delivered
                    - cancelled
                  example: shipped
      responses:
        '200':
          description: Order status updated
          content:
            application/json:
              schema:
                type: object
                properties:
                  id:
                    type: string
                    format: uuid
                  status:
                    type: string
                  updated_at:
                    type: string
                    format: date-time
        '400':
          description: Invalid status transition
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                status: 400
                error:
                  code: "INVALID_STATUS_TRANSITION"
                  message: "Cannot change status from delivered to pending"
                  path: "/api/v1/orders/{id}/status"

  /orders/{id}/payment-intent:
    post:
      tags:
        - Payments
      summary: Create payment intent
      description: |
        Creates a Stripe payment intent for an order. Returns client secret
        for frontend payment processing. Client access only for own orders.
      operationId: createPaymentIntent
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          description: Order ID
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Payment intent created
          content:
            application/json:
              schema:
                type: object
                properties:
                  client_secret:
                    type: string
                    description: Stripe client secret for payment processing
                    example: pi_3L7W8K2eZvKylo2C1...
                  amount:
                    type: integer
                    description: Payment amount in cents
                    example: 5000
                  currency:
                    type: string
                    description: Payment currency (ISO 4217)
                    example: usd
        '400':
          description: Order already paid or invalid state
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                status: 400
                error:
                  code: "ORDER_ALREADY_PAID"
                  message: "Order already paid"
                  path: "/api/v1/orders/{id}/payment-intent"
        '403':
          description: Not authorized to create payment for this order
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                status: 403
                error:
                  code: "FORBIDDEN"
                  message: "Not authorized to create payment for this order"
                  path: "/api/v1/orders/{id}/payment-intent"

  /webhooks/stripe:
    post:
      tags:
        - Webhooks
      summary: Stripe webhook endpoint
      description: |
        Receives payment events from Stripe. Automatically updates order status
        based on payment events. This endpoint is called by Stripe servers only
        and should be secured with webhook signature verification.
        
        Common events handled:
        - payment_intent.succeeded
        - payment_intent.payment_failed
        - charge.refunded
      operationId: handleStripeWebhook
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              description: Stripe Event object
              properties:
                id:
                  type: string
                type:
                  type: string
                  example: payment_intent.succeeded
                data:
                  type: object
      responses:
        '200':
          description: Webhook processed successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  received:
                    type: boolean
                    example: true
        '400':
          description: Invalid webhook signature or malformed payload
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                status: 400
                error:
                  code: "INVALID_WEBHOOK_SIGNATURE"
                  message: "Invalid webhook signature"
                  path: "/api/v1/webhooks/stripe"

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT access token obtained from login or registration

  schemas:
    ErrorResponse:
      type: object
      required:
        - status
        - error
      properties:
        status:
          type: integer
          description: HTTP status code
          example: 404
        error:
          type: object
          required:
            - code
            - message
            - path
          properties:
            code:
              type: string
              description: Machine-readable error code for client-side handling
              example: "RESOURCE_NOT_FOUND"
            message:
              type: string
              description: Human-readable error message
              example: "The requested resource was not found."
            path:
              type: string
              description: API endpoint path where the error occurred
              example: "/api/v1/users/12345"

    User:
      type: object
      properties:
        id:
          type: string
          format: uuid
        email:
          type: string
          format: email
        fullname:
          type: string
        role:
          type: string
          enum:
            - client
            - manager

    UserProfile:
      type: object
      properties:
        id:
          type: string
          format: uuid
        email:
          type: string
          format: email
        full_name:
          type: string
        role:
          type: string
          enum:
            - client
            - manager

    Address:
      type: object
      properties:
        id:
          type: string
          format: uuid
        address_line1:
          type: string
        city:
          type: string
        country:
          type: string
          description: ISO 3166-1 alpha-2 country code
          example: SV
        postal_code:
          type: string
        created_at:
          type: string
          format: date-time

    AddressInput:
      type: object
      required:
        - address_line1
        - city
        - country
        - postal_code
      properties:
        address_line1:
          type: string
          example: 123 Tech Blvd
        city:
          type: string
          example: San Salvador
        country:
          type: string
          description: ISO 3166-1 alpha-2 country code
          example: SV
        postal_code:
          type: string
          example: "11011"

    Category:
      type: object
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    CategoryWithCount:
      type: object
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
        product_count:
          type: integer
          description: Computed count of active products in this category

    ProductInput:
      type: object
      required:
        - title
        - description
        - category_ids
        - options
      properties:
        title:
          type: string
          example: Developer T-Shirt
        description:
          type: string
          example: 100% Cotton, pretty cool.
        category_ids:
          type: array
          items:
            type: string
            format: uuid
        options:
          type: array
          description: Product option groups (e.g., Color, Size)
          items:
            type: object
            required:
              - title
              - values
            properties:
              title:
                type: string
                example: Color
              values:
                type: array
                items:
                  type: string
                example:
                  - Red
                  - Black

    ProductCreated:
      type: object
      properties:
        id:
          type: string
          format: uuid
        title:
          type: string
        created_at:
          type: string
          format: date-time
        options:
          type: array
          items:
            type: object
            properties:
              id:
                type: string
                format: uuid
              title:
                type: string
        variants_count:
          type: integer

    ProductListItem:
      type: object
      properties:
        id:
          type: string
          format: uuid
        title:
          type: string
        image_url:
          type: string
          format: uri
          nullable: true
          description: URL of the first product image
        price_starts_at:
          type: integer
          description: Minimum price across all variants in cents
        category_names:
          type: array
          items:
            type: string

    ProductDetails:
      type: object
      properties:
        id:
          type: string
          format: uuid
        title:
          type: string
        description:
          type: string
        images:
          type: array
          items:
            type: object
            properties:
              id:
                type: string
                format: uuid
              url:
                type: string
                format: uri
        options:
          type: array
          description: Selectable product options for UI rendering
          items:
            type: object
            properties:
              id:
                type: string
                format: uuid
              title:
                type: string
                example: Color
              values:
                type: array
                items:
                  type: object
                  properties:
                    id:
                      type: string
                      format: uuid
                    value:
                      type: string
                      example: Black
        variants:
          type: array
          description: Available variants with option combination mappings
          items:
            type: object
            properties:
              id:
                type: string
                format: uuid
              sku:
                type: string
              price:
                type: integer
                description: Price in cents
              stock:
                type: integer
              combinations:
                type: object
                description: Maps option IDs to value IDs for variant selection
                additionalProperties:
                  type: string
                example:
                  opt-1: val-1
                  opt-2: val-3

    VariantInput:
      type: object
      required:
        - sku
        - price
        - stock_quantity
        - option_values
      properties:
        sku:
          type: string
          example: DEV-BLK-L
        price:
          type: integer
          description: Price in cents
          example: 2500
        stock_quantity:
          type: integer
          minimum: 0
          example: 50
        option_values:
          type: array
          description: List of option values defining this variant
          items:
            type: object
            required:
              - option_id
              - value
            properties:
              option_id:
                type: string
                format: uuid
              value:
                type: string
          example:
            - option_id: "3fa85f64-5717-4562-b3fc-2c963f66afa6"
              value: "Black"
            - option_id: "4fa85f64-5717-4562-b3fc-2c963f66afa7"
              value: "Large"

    Variant:
      type: object
      properties:
        id:
          type: string
          format: uuid
        sku:
          type: string
        price:
          type: integer
          description: Price in cents
        stock_quantity:
          type: integer
        option_values:
          type: array
          description: "The resolved values for this variant"
          items:
            type: object
            properties:
              option_id:
                type: string
                format: uuid
              option_title:
                type: string
                example: "Color"
              value:
                type: string
                example: "Black"
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    ProductImage:
      type: object
      properties:
        id:
          type: string
          format: uuid
        product_id:
          type: string
          format: uuid
        product_variant_id:
          type: string
          format: uuid
          nullable: true
          description: If set, image is specific to this variant
        url:
          type: string
          format: uri
        created_at:
          type: string
          format: date-time

    Cart:
      type: object
      properties:
        id:
          type: string
          format: uuid
        total_amount:
          type: integer
          description: Total cart value in cents (computed)
        items:
          type: array
          items:
            $ref: '#/components/schemas/CartItem'

    CartItem:
      type: object
      properties:
        id:
          type: string
          format: uuid
        product_variant_id:
          type: string
          format: uuid
        sku:
          type: string
        options:
          type: string
          description: Human-readable option combination for display
          example: "Size: M, Color: Black"
        options_text:
          type: string
          description: Alternative field name for human-readable options
          example: Black / M
        unit_price:
          type: integer
          description: Price per unit in cents
        price:
          type: integer
          description: Alternative field name for unit price
        quantity:
          type: integer
        subtotal:
          type: integer
          description: unit_price  quantity in cents (computed)

    OrderSummary:
      type: object
      properties:
        id:
          type: string
          format: uuid
        status:
          type: string
          enum:
            - pending
            - processing
            - shipped
            - delivered
            - cancelled
        total_amount:
          type: integer
          description: Order total in cents
        created_at:
          type: string
          format: date-time
        items_count:
          type: integer
          description: Number of items in the order (computed)

    OrderDetails:
      type: object
      properties:
        id:
          type: string
          format: uuid
        user_id:
          type: string
          format: uuid
        status:
          type: string
          enum:
            - pending
            - processing
            - shipped
            - delivered
            - cancelled
        total_amount:
          type: integer
          description: Order total in cents
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
        shipping_address_snapshot:
          type: object
          description: Address captured at order time for historical accuracy
          properties:
            address_line1:
              type: string
            city:
              type: string
            country:
              type: string
            postal_code:
              type: string
        items:
          type: array
          items:
            $ref: '#/components/schemas/OrderItem'

    OrderItem:
      type: object
      properties:
        id:
          type: string
          format: uuid
        product_name_snapshot:
          type: string
          description: Product name captured at purchase time
        variant_sku_snapshot:
          type: string
          description: SKU captured at purchase time
        unit_price_at_purchase:
          type: integer
          description: Price per unit in cents at time of purchase
        quantity:
          type: integer
        total_price:
          type: integer
          description: unit_price_at_purchase  quantity in cents

    PaginationMeta:
      type: object
      properties:
        total:
          type: integer
          description: Total number of items across all pages
        page:
          type: integer
          description: Current page number
        limit:
          type: integer
          description: Items per page